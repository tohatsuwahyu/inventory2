<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在庫管理</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --sb:#0f2242; --bg:#f5f7fb; }
    body{ background:var(--bg); font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif }

    /* ===== Sidebar ===== */
    .sidebar{ width:270px; position:fixed; inset:0 auto 0 0; background:var(--sb); color:#fff; z-index:1030;
      transform:none; transition:transform .25s ease; }
    .sidebar .brand{ padding:16px 20px; display:flex; gap:12px; align-items:center; border-bottom:1px solid rgba(255,255,255,.08) }
    .sidebar .brand img{ width:38px; height:38px; object-fit:contain; background:#fff; border-radius:6px }
    .sidebar .brand .role{ font-size:12px; color:#c7d3ea }
    .sidebar nav{ position:relative; padding-top:6px; }
    .sidebar nav a{ display:block; padding:12px 18px; margin:6px 12px; border-radius:10px; color:#c7d3ea; text-decoration:none;
      position:relative; overflow:hidden; transition: background-color .25s ease, color .25s ease, transform .12s ease; }
    .sidebar nav a.active,.sidebar nav a:hover{ background:#1b2b4b; color:#fff }
    .sidebar nav a:active{ transform: scale(.98); }
    .sidebar .nav-indicator{
      position:absolute; left:6px; width:4px; border-radius:4px;
      background:#5da8ff; box-shadow:0 0 0 2px #5da8ff22;
      transition: transform .25s cubic-bezier(.2,.8,.2,1), height .25s;
      transform: translateY(var(--ind-top, 0)); height: var(--ind-h, 44px);
    }

    /* ===== Content + topbar ===== */
    .content{ margin-left:270px; padding:24px }
    .topbar{ display:flex; align-items:center; gap:8px; margin-bottom:12px }
    .topbar .title{ margin:0 }

    /* ===== Tables / QR / print ===== */
    .table thead th{ background:#f0f3f9 }
    .qr-cell canvas,.qr-cell img{ width:84px; height:84px }
    .thumb{ width:56px; height:56px; object-fit:cover; border:1px solid #e5e7eb; border-radius:6px }
    @media print{
      .sidebar,.no-print,.topbar{ display:none!important }
      .content{ margin:0; padding:0 }
      .qr-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; padding:18px }
      .qr-card{ border:1px solid #ddd; padding:10px; text-align:center }
      .qr-card .title{ font-size:12px; margin-top:6px }
    }

    /* ===== Mobile responsive ===== */
    .backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1025; }
    .backdrop.show{ display:block; }

    @media (max-width: 991.98px){
      .sidebar{ transform:translateX(-100%); box-shadow:none; }
      .sidebar.open{ transform:translateX(0); box-shadow: 0 0 0 9999px rgba(0,0,0,.0); }
      .content{ margin-left:0; padding:16px }
      .topbar{ position:sticky; top:0; z-index:1020; background:var(--bg); padding:10px 6px; border-bottom:1px solid #e9edf5; }
    }

    /* Section fade/slide */
    main section{ opacity:0; transform: translateY(6px); transition: opacity .24s ease, transform .24s ease; }
    main section.active{ opacity:1; transform:none; }
  </style>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart, QR -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- App -->
  <script src="config.js"></script>
  <script defer src="app.js"></script>
</head>
<body>

  <!-- Backdrop untuk mobile -->
  <div id="backdrop" class="backdrop"></div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <img id="brand-logo" src="./assets/tsh.png" alt="logo">
      <div>
        <div class="fw-bold">TSH 在庫管理</div>
        <div id="who" class="role">—</div>
      </div>
    </div>
    <nav class="mt-2">
      <a class="active" data-view="view-dashboard"><i class="bi bi-house-door me-2"></i> ダッシュボード</a>
      <a data-view="view-io"><i class="bi bi-arrow-left-right me-2"></i> 入出庫（QR対応）</a>
      <a data-view="view-stocktake"><i class="bi bi-clipboard-check me-2"></i> 棚卸</a>
      <a data-view="view-items"><i class="bi bi-box-seam me-2"></i> 商品一覧</a>
      <a data-view="view-users"><i class="bi bi-person-badge me-2"></i> ユーザー / QR</a>
      <a data-view="view-history"><i class="bi bi-clock-history me-2"></i> 履歴</a>
      <span class="nav-indicator"></span>
    </nav>
  </aside>

  <!-- Main -->
  <main class="content">
    <!-- Topbar: burger + title + logout -->
    <div class="topbar no-print">
      <button id="btn-menu" class="btn btn-outline-secondary d-lg-none"><i class="bi bi-list"></i></button>
      <h5 id="page-title" class="title">ダッシュボード</h5>
      <div class="ms-auto">
        <button id="btn-logout" class="btn btn-outline-secondary btn-sm"><i class="bi bi-box-arrow-right me-1"></i> ログアウト</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="view-dashboard">
      <div class="row g-3">
        <div class="col-md-3 col-6"><div class="card shadow-sm"><div class="card-body"><div class="text-muted small">総アイテム</div><div id="metric-total-items" class="h4 mb-0">—</div></div></div></div>
        <div class="col-md-3 col-6"><div class="card shadow-sm"><div class="card-body"><div class="text-muted small">最小在庫以下</div><div id="metric-low-stock" class="h4 mb-0">—</div></div></div></div>
        <div class="col-md-3 col-6"><div class="card shadow-sm"><div class="card-body"><div class="text-muted small">ユーザー</div><div id="metric-users" class="h4 mb-0">—</div></div></div></div>
        <div class="col-md-3 col-6"><div class="card shadow-sm"><div class="card-body"><div class="text-muted small">直近30日の取引</div><div id="metric-txn" class="h4 mb-0">—</div></div></div></div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header bg-white">月次 IN / OUT</div>
        <div class="card-body"><canvas id="chart-monthly" height="100"></canvas></div>
      </div>
    </section>

    <!-- 入出庫 -->
    <section id="view-io" class="d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <span>入出庫（QRスキャン対応）</span>
          <div class="no-print">
            <button id="btn-io-scan" class="btn btn-sm btn-primary me-2"><i class="bi bi-qr-code-scan me-1"></i> スキャン開始</button>
            <button id="btn-io-stop" class="btn btn-sm btn-outline-secondary"><i class="bi bi-stop-circle me-1"></i> 停止</button>
          </div>
        </div>
        <div class="card-body">
          <div id="io-scan-area" class="mb-3" style="max-width:520px"></div>
          <form id="form-io" class="row g-3">
            <div class="col-md-3 col-6"><label class="form-label">コード</label><input id="io-code" class="form-control" required></div>
            <div class="col-md-5 col-6"><label class="form-label">名称</label><input id="io-name" class="form-control" readonly></div>
            <div class="col-md-2 col-6"><label class="form-label">単価（JPY）</label><input id="io-price" class="form-control" readonly></div>
            <div class="col-md-2 col-6"><label class="form-label">在庫</label><input id="io-stock" class="form-control" readonly></div>

            <div class="col-md-3 col-6"><label class="form-label">数量</label><input id="io-qty" type="number" class="form-control" required></div>
            <div class="col-md-3 col-6"><label class="form-label">単位</label>
              <select id="io-unit" class="form-select"><option value="pcs">pcs</option><option value="g">g</option></select>
            </div>
            <div class="col-md-3 col-6"><label class="form-label">種別</label>
              <select id="io-type" class="form-select"><option value="IN">IN</option><option value="OUT">OUT</option></select>
            </div>
            <div class="col-12"><button class="btn btn-primary"><i class="bi bi-save me-1"></i> 登録</button></div>
          </form>
        </div>
      </div>
    </section>

    <!-- 棚卸 -->
    <section id="view-stocktake" class="d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <span>棚卸（QR/手動）</span>
          <div class="no-print">
            <button id="btn-start-scan" class="btn btn-sm btn-primary me-2"><i class="bi bi-camera-video me-1"></i> スキャン開始</button>
            <button id="btn-stop-scan" class="btn btn-sm btn-outline-secondary"><i class="bi bi-stop-circle me-1"></i> 停止</button>
          </div>
        </div>
        <div class="card-body">
          <div id="scan-area" class="mb-3" style="max-width:520px"></div>
          <div class="row g-2 mb-3">
            <div class="col-md-4 col-6"><input id="st-code" class="form-control" placeholder="コード手入力"></div>
            <div class="col-md-3 col-6"><input id="st-qty" type="number" class="form-control" placeholder="実在庫数量"></div>
            <div class="col-md-3 col-6"><button id="st-add" class="btn btn-secondary w-100">追加</button></div>
            <div class="col-md-2 col-6"><button id="st-export" class="btn btn-outline-secondary w-100">CSV出力</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead><tr><th>コード</th><th>名称</th><th class="text-end">帳簿在庫</th><th class="text-end">実在庫</th><th class="text-end">差分</th></tr></thead>
              <tbody id="tbl-stocktake"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 商品一覧 -->
    <section id="view-items" class="d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <span>商品一覧</span>
          <div class="no-print d-flex gap-2">
            <button id="btn-items-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
            <button id="btn-open-new-item" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i> 新規</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>QR</th><th>コード</th><th>名称</th><th>画像</th>
                  <th class="text-end">価格</th><th class="text-end">在庫</th><th class="text-end">最小</th>
                  <th class="text-end">ダウンロード</th>
                </tr>
              </thead>
              <tbody id="tbl-items"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ユーザー / QR -->
    <section id="view-users" class="d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <span>ユーザー / QR</span>
          <div class="no-print d-flex gap-2">
            <button id="btn-print-qr-users" class="btn btn-sm btn-outline-secondary"><i class="bi bi-printer me-1"></i> 印刷（A4）</button>
            <button id="btn-open-new-user" class="btn btn-sm btn-primary d-none"><i class="bi bi-person-plus me-1"></i> 追加</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive no-print">
            <table class="table table-sm align-middle">
              <thead><tr><th>QR</th><th>ID</th><th>名前</th><th>ロール</th></tr></thead>
              <tbody id="tbl-userqr"></tbody>
            </table>
          </div>
          <div id="print-qr-users" class="d-none"><div class="qr-grid" id="print-qr-users-grid"></div></div>
        </div>
      </div>
    </section>

    <!-- 履歴 -->
    <section id="view-history" class="d-none">
      <div class="card shadow-sm">
        <div class="card-header bg-white">履歴</div>
        <div class="card-body">
          <div class="table-responsive"><table class="table table-sm align-middle">
            <thead><tr><th>日時</th><th>ユーザー</th><th>コード</th><th class="text-end">数量</th><th>単位</th><th>種別</th></tr></thead>
            <tbody id="tbl-history"></tbody>
          </table></div>
        </div>
      </div>
    </section>
  </main>

  <!-- 新規ユーザー -->
  <div class="modal fade" id="dlg-new-user" tabindex="-1"><div class="modal-dialog">
    <form id="form-user" class="modal-content">
      <div class="modal-header"><h6 class="modal-title">ユーザー追加</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label">名前</label><input id="u-name" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">ID</label><input id="u-id" class="form-control" required></div>
        <div class="mb-2">
          <label class="form-label">ロール</label>
          <select id="u-role" class="form-select"><option value="user">user</option><option value="admin">admin</option></select>
        </div>
        <div><label class="form-label">PIN</label><input id="u-pin" class="form-control"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary"><i class="bi bi-save me-1"></i> 保存</button></div>
    </form>
  </div></div>

  <!-- 新規商品 -->
  <div class="modal fade" id="dlg-new-item" tabindex="-1"><div class="modal-dialog modal-lg">
    <form id="form-item" class="modal-content">
      <div class="modal-header"><h6 class="modal-title">新規商品</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-md-3 col-6"><label class="form-label">コード</label><input id="i-code" class="form-control" readonly><div class="form-text">自動採番（開くたびに更新）</div></div>
          <div class="col-md-5 col-6"><label class="form-label">名称</label><input id="i-name" class="form-control" required></div>
          <div class="col-md-2 col-6"><label class="form-label">価格</label><input id="i-price" type="number" class="form-control" value="0"></div>
          <div class="col-md-1 col-6"><label class="form-label">在庫</label><input id="i-stock" type="number" class="form-control" value="0"></div>
          <div class="col-md-1 col-6"><label class="form-label">最小</label><input id="i-min" type="number" class="form-control" value="0"></div>
          <div class="col-12"><label class="form-label">画像URL（任意）</label><input id="i-img" class="form-control" placeholder="https://..."></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> 登録</button>
        <button type="button" id="btn-item-makeqr" class="btn btn-outline-primary"><i class="bi bi-qr-code me-1"></i> QRをプレビュー</button>
      </div>
    </form>
  </div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
